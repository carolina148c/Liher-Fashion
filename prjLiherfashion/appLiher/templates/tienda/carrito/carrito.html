
{% load static %}

{% block title %}Carrito de Compras - Liher Fashion{% endblock %}

{% block content %}
<div class="carrito-container">
    <div class="carrito-header">
        <h1>Carrito de Compras</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'pagina_principal' %}">Inicio</a></li>
                <li class="breadcrumb-item active">Carrito</li>
            </ol>
        </nav>
    </div>

    {% if items_carrito %}
    <div class="carrito-content">
        <div class="carrito-items">
            <div class="items-header">
                <h2>Productos en tu carrito ({{ carrito.total_items_carrito }})</h2>
                <form method="post" action="{% url 'limpiar_carrito' %}" class="d-inline" id="limpiarCarritoForm">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash"></i> Vaciar Carrito
                    </button>
                </form>
            </div>

            <div class="items-list">
                {% for item in items_carrito %}
                <div class="carrito-item" id="item-{{ item.id }}">
                    <div class="item-image">
                        {% if item.producto.imagen %}
                        <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.producto.nombre }}">
                        {% else %}
                        <img src="{% static 'img/default-product.jpg' %}" alt="{{ item.producto.producto.nombre }}">
                        {% endif %}
                    </div>
                    
                    <div class="item-details">
                        <h4>{{ item.producto.producto.nombre }}</h4>
                        <p class="item-variant">
                            <strong>Talla:</strong> {{ item.producto.talla.talla }} | 
                            <strong>Color:</strong> {{ item.producto.color.color }}
                        </p>
                        <p class="item-reference">
                            <strong>Referencia:</strong> {{ item.producto.producto.referencia }}
                        </p>
                        
                        {% if item.producto.stock < item.cantidad %}
                        <div class="stock-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Stock insuficiente. Disponible: {{ item.producto.stock }}
                        </div>
                        {% elif item.producto.stock <= 5 %}
                        <div class="stock-low">
                            <i class="bi bi-info-circle"></i>
                            ¡Últimas unidades! Solo {{ item.producto.stock }} disponibles
                        </div>
                        {% else %}
                        <div class="stock-ok">
                            <i class="bi bi-check-circle"></i>
                            En stock
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="item-controls">
                        <div class="quantity-selector">
                            <button type="button" class="quantity-btn minus" 
                                    onclick="updateQuantity({{ item.id }}, -1)">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" 
                                   value="{{ item.cantidad }}" 
                                   min="1" 
                                   max="{{ item.producto.stock }}"
                                   class="quantity-input"
                                   id="quantity-{{ item.id }}"
                                   onchange="updateItem({{ item.id }}, this.value)">
                            <button type="button" class="quantity-btn plus"
                                    onclick="updateQuantity({{ item.id }}, 1)">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        
                        <div class="item-prices">
                            <div class="price-unit">
                                ${{ item.precio_unitario|floatformat:0 }} c/u
                            </div>
                            <div class="price-total" id="item-total-{{ item.id }}">
                                ${{ item.total_precio|floatformat:0 }}
                            </div>
                        </div>
                        
                        <button type="button" class="btn-remove" 
                                onclick="removeItem({{ item.id }})">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="carrito-summary">
            <div class="summary-card">
                <h3>Resumen del Pedido</h3>
                
                <div class="summary-details">
                    <div class="summary-row">
                        <span>Subtotal ({{ carrito.total_items_carrito }} productos)</span>
                        <span id="summary-subtotal">${{ subtotal|floatformat:0 }}</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>Envío</span>
                        <span class="free-shipping">Gratis</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>IVA (19%)</span>
                        <span id="summary-iva">${{ iva|floatformat:0 }}</span>
                    </div>
                    
                    <div class="summary-divider"></div>
                    
                    <div class="summary-row total">
                        <strong>Total</strong>
                        <strong id="summary-total">${{ total|floatformat:0 }}</strong>
                    </div>
                </div>
                
                <div class="summary-actions">
                    {% if user.is_authenticated %}
                    <a href="#" class="btn btn-primary btn-checkout">
                        <i class="bi bi-lock-fill"></i> Proceder al Pago
                    </a>
                    {% else %}
                    <div class="login-required">
                        <p>Inicia sesión para continuar con la compra</p>
                        <a href="{% url 'acceso' %}?next={% url 'carrito' %}" class="btn btn-primary">
                            <i class="bi bi-person"></i> Iniciar Sesión
                        </a>
                    </div>
                    {% endif %}
                    
                    <a href="{% url 'vista_productos' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Seguir Comprando
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="carrito-vacio">
        <div class="empty-cart">
            <i class="bi bi-cart-x"></i>
            <h2>Tu carrito está vacío</h2>
            <p>¡Descubre nuestras increíbles colecciones y encuentra tu estilo perfecto!</p>
            <a href="{% url 'vista_productos' %}" class="btn btn-primary">
                <i class="bi bi-bag"></i> Comenzar a Comprar
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.carrito-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.carrito-header {
    margin-bottom: 2rem;
}

.carrito-header h1 {
    color: #e91e63;
    margin-bottom: 0.5rem;
}

.carrito-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 2rem;
    align-items: start;
}

.items-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #dee2e6;
}

.items-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.carrito-item {
    display: grid;
    grid-template-columns: 120px 1fr auto;
    gap: 1.5rem;
    padding: 1.5rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
}

.carrito-item:hover {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-color: #e91e63;
}

.item-image {
    width: 120px;
    height: 120px;
    border-radius: 8px;
    overflow: hidden;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-details h4 {
    margin-bottom: 0.5rem;
    color: #333;
}

.item-variant, .item-reference {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.stock-warning {
    color: #dc3545;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stock-low {
    color: #ffc107;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stock-ok {
    color: #28a745;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.item-controls {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 1rem;
}

.quantity-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quantity-btn {
    width: 35px;
    height: 35px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quantity-btn:hover {
    background: #e91e63;
    color: white;
    border-color: #e91e63;
}

.quantity-input {
    width: 60px;
    height: 35px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    text-align: center;
    font-weight: 500;
}

.item-prices {
    text-align: right;
}

.price-unit {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.price-total {
    font-weight: 700;
    color: #e91e63;
    font-size: 1.1rem;
}

.btn-remove {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-remove:hover {
    background: #dc3545;
    color: white;
}

.carrito-summary {
    position: sticky;
    top: 2rem;
}

.summary-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 2rem;
}

.summary-card h3 {
    margin-bottom: 1.5rem;
    color: #333;
    text-align: center;
}

.summary-details {
    margin-bottom: 1.5rem;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #dee2e6;
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-row.total {
    font-size: 1.2rem;
    padding-top: 1rem;
}

.free-shipping {
    color: #28a745;
    font-weight: 600;
}

.summary-divider {
    height: 2px;
    background: #dee2e6;
    margin: 1rem 0;
}

.summary-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.btn-checkout {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
}

.login-required {
    text-align: center;
    padding: 1rem;
    background: #e3f2fd;
    border-radius: 8px;
}

.login-required p {
    margin-bottom: 1rem;
    color: #333;
}

.carrito-vacio {
    text-align: center;
    padding: 3rem 2rem;
}

.empty-cart i {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 1.5rem;
}

.empty-cart h2 {
    margin-bottom: 1rem;
    color: #333;
}

.empty-cart p {
    color: #6c757d;
    margin-bottom: 2rem;
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .carrito-content {
        grid-template-columns: 1fr;
    }
    
    .carrito-item {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .item-controls {
        align-items: center;
    }
    
    .item-prices {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateQuantity(itemId, change) {
    const input = document.getElementById(`quantity-${itemId}`);
    let newValue = parseInt(input.value) + change;
    const max = parseInt(input.max);
    const min = parseInt(input.min);
    
    if (newValue > max) {
        alert(`No puedes agregar más de ${max} unidades`);
        return;
    }
    
    if (newValue < min) {
        newValue = min;
    }
    
    input.value = newValue;
    updateItem(itemId, newValue);
}

function updateItem(itemId, quantity) {
    const formData = new FormData();
    formData.append('cantidad', quantity);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/carrito/actualizar/${itemId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar precios en la interfaz
            document.getElementById(`item-total-${itemId}`).textContent = `$${data.item_subtotal.toLocaleString('es-CO')}`;
            document.getElementById('summary-subtotal').textContent = `$${data.subtotal.toLocaleString('es-CO')}`;
            document.getElementById('summary-iva').textContent = `$${data.iva.toLocaleString('es-CO')}`;
            document.getElementById('summary-total').textContent = `$${data.total.toLocaleString('es-CO')}`;
            
            // Actualizar contador del carrito
            updateCartCount(data.carrito_count);
            
            // Si la cantidad es 0, eliminar el item de la vista
            if (quantity === 0) {
                document.getElementById(`item-${itemId}`).remove();
            }
        } else {
            alert(data.message);
            // Recargar para sincronizar
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar el carrito');
    });
}

function removeItem(itemId) {
    if (!confirm('¿Eliminar este producto del carrito?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/carrito/eliminar/${itemId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Eliminar item de la vista
            document.getElementById(`item-${itemId}`).remove();
            
            // Actualizar precios
            document.getElementById('summary-subtotal').textContent = `$${data.subtotal.toLocaleString('es-CO')}`;
            document.getElementById('summary-iva').textContent = `$${data.iva.toLocaleString('es-CO')}`;
            document.getElementById('summary-total').textContent = `$${data.total.toLocaleString('es-CO')}`;
            
            // Actualizar contador del carrito
            updateCartCount(data.carrito_count);
            
            // Si no hay items, recargar para mostrar carrito vacío
            if (data.carrito_count === 0) {
                location.reload();
            }
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar el producto');
    });
}

function updateCartCount(count) {
    const cartCount = document.getElementById('carrito-count');
    if (cartCount) {
        cartCount.textContent = count;
    }
}

// Manejar el formulario de limpiar carrito
document.getElementById('limpiarCarritoForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!confirm('¿Estás seguro de que quieres vaciar el carrito?')) {
        return;
    }
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al vaciar el carrito');
    });
});
</script>
{% endblock %}