{% extends 'tienda/base.html' %}
{% load static %}

{% block title %}Productos - Liher Fashion{% endblock %}

{% block extra_css %}
<style>
.productos-page {
    max-width: 1800px;
    margin: 0 auto;
    padding: 4rem 6rem;
}

.page-header {
    margin-bottom: 3rem;
}

.page-header h1 {
    font-size: 3.2rem;
    color: var(--dark-color);
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 1rem;
}

.breadcrumb {
    display: flex;
    gap: 1rem;
    list-style: none;
    font-size: 1.4rem;
    color: #999;
}

.breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

/* Layout principal */
.productos-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 4rem;
}

/* Sidebar de filtros */
.filtros-sidebar {
    position: sticky;
    top: 150px;
    height: fit-content;
}

.filtros-sidebar h3 {
    font-size: 1.8rem;
    color: var(--dark-color);
    font-weight: 500;
    letter-spacing: 1.5px;
    margin-bottom: 2.5rem;
    text-transform: uppercase;
}

.filtro-group {
    margin-bottom: 3rem;
    padding-bottom: 2.5rem;
    border-bottom: 1px solid var(--border-color);
}

.filtro-group:last-child {
    border-bottom: none;
}

.filtro-group label {
    display: block;
    font-size: 1.4rem;
    font-weight: 500;
    color: var(--dark-color);
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.filtro-group input[type="text"] {
    width: 100%;
    padding: 1.2rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1.4rem;
    transition: all 0.3s ease;
}

.filtro-group input[type="text"]:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(247, 178, 198, 0.1);
}

.filtro-group select {
    width: 100%;
    padding: 1.2rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1.4rem;
    background: var(--white);
    cursor: pointer;
    transition: all 0.3s ease;
}

.filtro-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(247, 178, 198, 0.1);
}

/* Opciones de color */
.color-options {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
}

.color-option:hover,
.color-option.selected {
    border-color: var(--primary-color);
    transform: scale(1.1);
}

.color-option.selected::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    text-shadow: 0 0 3px rgba(0,0,0,0.5);
}

/* Opciones de talla */
.talla-options {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.talla-option {
    padding: 1rem 1.8rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1.3rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--white);
}

.talla-option:hover,
.talla-option.selected {
    background: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
}

/* Rango de precio */
.precio-range {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.precio-input {
    width: 100%;
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1.3rem;
}

/* Botón limpiar filtros */
.btn-limpiar {
    width: 100%;
    padding: 1.2rem;
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
    border-radius: 8px;
    font-size: 1.4rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn-limpiar:hover {
    background: var(--primary-color);
    color: var(--white);
}

/* Área de productos */
.productos-content {
    min-height: 600px;
}

.productos-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border-color);
}

.productos-count {
    font-size: 1.5rem;
    color: #666;
}

.productos-ordenar {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.productos-ordenar label {
    font-size: 1.4rem;
    color: var(--dark-color);
    font-weight: 500;
}

.productos-ordenar select {
    padding: 1rem 3rem 1rem 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1.4rem;
    background: var(--white);
    cursor: pointer;
}

/* Grid de productos */
.productos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 3rem;
    margin-bottom: 5rem;
}

.producto-card {
    background: var(--white);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.4s ease;
    cursor: pointer;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.producto-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-hover);
}

.producto-card-imagen {
    position: relative;
    padding-top: 130%;
    overflow: hidden;
    background: #f8f8f8;
}

.producto-card-imagen img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.producto-card:hover .producto-card-imagen img {
    transform: scale(1.08);
}

.producto-categoria {
    position: absolute;
    top: 12px;
    left: 12px;
    background: rgba(247, 178, 198, 0.95);
    color: var(--white);
    padding: 0.6rem 1.4rem;
    border-radius: 20px;
    font-size: 1.2rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.producto-quick-actions {
    position: absolute;
    top: 12px;
    right: 12px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.producto-card:hover .producto-quick-actions {
    opacity: 1;
}

.quick-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.quick-btn:hover {
    background: var(--primary-color);
    color: var(--white);
    transform: scale(1.1);
}

.quick-btn i {
    font-size: 1.8rem;
}

.producto-card-body {
    padding: 2rem;
}

.producto-card-titulo {
    font-size: 1.6rem;
    font-weight: 500;
    color: var(--dark-color);
    margin-bottom: 0.8rem;
    line-height: 1.4;
}

.producto-card-referencia {
    font-size: 1.2rem;
    color: #999;
    margin-bottom: 1.2rem;
}

.producto-card-precio {
    font-size: 2rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1.5rem;
}

.producto-variantes {
    margin-bottom: 1.5rem;
    min-height: 30px;
}

.variantes-preview {
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.variante-badge {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid var(--border-color);
    display: inline-block;
}

.variante-more {
    font-size: 1.2rem;
    color: #999;
}

.producto-card-botones {
    display: flex;
    gap: 1rem;
}

.btn-producto {
    flex: 1;
    padding: 1.2rem;
    border: none;
    border-radius: 8px;
    font-size: 1.3rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
}

.btn-agregar {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.btn-agregar:hover {
    background: var(--primary-color);
    color: var(--white);
}

.btn-comprar {
    background: var(--primary-color);
    color: var(--white);
}

.btn-comprar:hover {
    background: var(--accent-color);
}

/* No productos */
.no-productos {
    grid-column: 1 / -1;
    text-align: center;
    padding: 8rem 2rem;
}

.no-productos i {
    font-size: 6rem;
    color: #ddd;
    margin-bottom: 2rem;
}

.no-productos h3 {
    font-size: 2.4rem;
    color: var(--dark-color);
    margin-bottom: 1rem;
    font-weight: 400;
}

.no-productos p {
    font-size: 1.5rem;
    color: #999;
    margin-bottom: 2.5rem;
}

.no-productos .btn {
    display: inline-block;
    padding: 1.2rem 3rem;
    background: var(--primary-color);
    color: var(--white);
    text-decoration: none;
    border-radius: 8px;
    font-size: 1.4rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.no-productos .btn:hover {
    background: var(--accent-color);
    transform: translateY(-2px);
}

/* Paginación */
.pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 5rem;
}

.pagination {
    display: flex;
    gap: 1rem;
    list-style: none;
}

.page-item {
    display: inline-block;
}

.page-link {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 45px;
    height: 45px;
    padding: 0 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--dark-color);
    text-decoration: none;
    font-size: 1.4rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.page-link:hover {
    background: var(--secondary-color);
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.page-item.active .page-link {
    background: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
}

/* Responsive */
@media (max-width: 1200px) {
    .productos-layout {
        grid-template-columns: 250px 1fr;
        gap: 3rem;
    }
}

@media (max-width: 992px) {
    .productos-page {
        padding: 3rem 4rem;
    }
    
    .productos-layout {
        grid-template-columns: 1fr;
    }
    
    .filtros-sidebar {
        position: static;
        margin-bottom: 3rem;
    }
    
    .productos-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .productos-page {
        padding: 2rem;
    }
    
    .page-header h1 {
        font-size: 2.4rem;
    }
    
    .productos-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 2rem;
    }
    
    .productos-header {
        flex-direction: column;
        gap: 1.5rem;
        align-items: flex-start;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="productos-page">
    <div class="page-header">
        <h1>Nuestros Productos</h1>
    </div>

    <div class="productos-layout">
        <!-- Sidebar de filtros -->
        <aside class="filtros-sidebar">
            <h3>Filtros</h3>
            
            <form method="get" id="filtrosForm">
                <!-- Búsqueda -->
                <div class="filtro-group">
                    <label>Buscar</label>
                    <input type="text" 
                           name="q" 
                           placeholder="Buscar productos..." 
                           value="{{ busqueda }}">
                    <input type="hidden" name="categoria" value="{{ selected_categoria }}">
                    <input type="hidden" name="color" value="{{ selected_color }}">
                    <input type="hidden" name="talla" value="{{ selected_talla }}">
                </div>

                <!-- Talla -->
                <div class="filtro-group">
                    <label>
                        Talla
                        <i class="bi bi-chevron-down"></i>
                    </label>
                    <div class="talla-options">
                        {% for talla in tallas %}
                        <button type="button" 
                                class="talla-option {% if selected_talla == talla.talla %}selected{% endif %}"
                                onclick="aplicarFiltro('talla', '{{ talla.talla }}')">
                            {{ talla.talla }}
                        </button>
                        {% endfor %}
                    </div>
                    {% if tallas|length > 8 %}
                    <button type="button" class="mostrar-mas">Mostrar más</button>
                    {% endif %}
                </div>

                <!-- Color -->
                <div class="filtro-group">
                    <label>
                        Color
                        <i class="bi bi-chevron-down"></i>
                    </label>
                    <div class="color-options">
                        {% for color in colores %}
                        <div class="color-item">
                            <button type="button" 
                                    class="color-option {% if selected_color == color.color %}selected{% endif %}"
                                    style="background-color: {{ color.codigo_hex|default:'#CCCCCC' }}"
                                    onclick="aplicarFiltro('color', '{{ color.color }}')"
                                    title="{{ color.color }}">
                            </button>
                            <span class="color-name">{{ color.color }} ({{ color.count|default:0 }})</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Categoría -->
                <div class="filtro-group">
                    <label>
                        Categoría
                        <i class="bi bi-chevron-down"></i>
                    </label>
                    <div class="categoria-options">
                        {% for categoria in categorias %}
                        <label class="categoria-item">
                            <input type="radio" 
                                   name="categoria" 
                                   value="{{ categoria.categoria }}"
                                   {% if selected_categoria == categoria.categoria %}checked{% endif %}
                                   onchange="aplicarFiltro('categoria', '{{ categoria.categoria }}')">
                            <span>{{ categoria.categoria }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Precio -->
                <div class="filtro-group">
                    <label>
                        Precio
                        <i class="bi bi-chevron-down"></i>
                    </label>
                    <div class="precio-range">
                        <div class="precio-inputs">
                            <input type="number" 
                                   name="precio_min" 
                                   placeholder="$ 0"
                                   value="{{ precio_min }}"
                                   class="precio-input">
                            <span>Para</span>
                            <input type="number" 
                                   name="precio_max" 
                                   placeholder="$ 1000000"
                                   value="{{ precio_max }}"
                                   class="precio-input">
                        </div>
                        <input type="range" 
                               min="0" 
                               max="1000000" 
                               step="10000"
                               class="precio-slider">
                        <p class="precio-texto">El precio más alto es $1.000.000</p>
                    </div>
                </div>

                <!-- Limpiar filtros -->
                {% if selected_categoria or selected_color or selected_talla or busqueda or precio_min or precio_max %}
                <div class="filtro-group">
                    <a href="{% url 'vista_productos' %}" class="btn-limpiar">
                        <i class="bi bi-x-circle"></i> Limpiar Filtros
                    </a>
                </div>
                {% endif %}
            </form>
        </aside>

        <!-- Contenido de productos -->
        <div class="productos-content">
            <!-- Header con conteo y ordenamiento -->
            <div class="productos-header">
                <div class="productos-count">
                    Mostrando {{ productos|length }} producto{{ productos|length|pluralize }}
                </div>
                <div class="productos-ordenar">
                    <label>Ordenar por:</label>
                    <select onchange="location.href='?ordenar=' + this.value">
                        <option value="reciente">Más recientes</option>
                        <option value="precio_asc">Precio: Menor a Mayor</option>
                        <option value="precio_desc">Precio: Mayor a Menor</option>
                        <option value="nombre">Nombre A-Z</option>
                    </select>
                </div>
            </div>

            <!-- Grid de productos -->
            <div class="productos-grid">
                {% for producto in productos %}
                <div class="producto-card" data-producto-id="{{ producto.idproducto }}">
                    <div class="producto-card-imagen">
                        {% if producto.imagen %}
                            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" loading="lazy">
                        {% else %}
                            <img src="{% static 'img/default-product.jpg' %}" alt="{{ producto.nombre }}" loading="lazy">
                        {% endif %}
                        
                        {% if producto.categoria %}
                        <div class="producto-categoria">
                            {{ producto.categoria.categoria }}
                        </div>
                        {% endif %}

                        <div class="producto-quick-actions">
                            <button class="quick-btn" onclick="event.stopPropagation(); verDetalleRapido({{ producto.idproducto }})" title="Ver detalles">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="quick-btn" onclick="event.stopPropagation(); agregarFavorito({{ producto.idproducto }})" title="Agregar a favoritos">
                                <i class="bi bi-heart"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="producto-card-body">
                        <h3 class="producto-card-titulo">{{ producto.nombre }}</h3>
                        <p class="producto-card-referencia">Ref: {{ producto.referencia }}</p>
                        <p class="producto-card-precio">${{ producto.precio|floatformat:0 }}</p>
                        
                        <div class="producto-variantes">
                            {% with variantes=producto.variantes.all %}
                                {% if variantes %}
                                <div class="variantes-preview">
                                    {% for variante in variantes|slice:":3" %}
                                    <span class="variante-badge" 
                                          style="background-color: {{ variante.color.codigo_hex|default:'#CCCCCC' }}"
                                          title="{{ variante.talla.talla }} - {{ variante.color.color }}">
                                    </span>
                                    {% endfor %}
                                    {% if variantes|length > 3 %}
                                    <span class="variante-more">+{{ variantes|length|add:"-3" }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        
                        <div class="producto-card-botones">
                            <button class="btn-producto btn-agregar" 
                                    onclick="event.stopPropagation(); agregarAlCarritoRapido({{ producto.idproducto }})">
                                <i class="bi bi-cart-plus"></i> Agregar
                            </button>
                            <button class="btn-producto btn-comprar" 
                                    onclick="event.stopPropagation(); verDetalleRapido({{ producto.idproducto }})">
                                <i class="bi bi-eye"></i> Ver
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="no-productos">
                    <i class="bi bi-search"></i>
                    <h3>No se encontraron productos</h3>
                    <p>Intenta con otros filtros o términos de búsqueda.</p>
                    <a href="{% url 'vista_productos' %}" class="btn">Ver todos los productos</a>
                </div>
                {% endfor %}
            </div>

            <!-- Paginación -->
            {% if productos.has_other_pages %}
            <div class="pagination-container">
                <nav aria-label="Paginación de productos">
                    <ul class="pagination">
                        {% if productos.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ productos.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        {% for num in productos.paginator.page_range %}
                            {% if productos.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > productos.number|add:'-3' and num < productos.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ num }}
                                </a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if productos.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ productos.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Aplicar filtros sin recargar
function aplicarFiltro(tipo, valor) {
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    
    // Si el filtro ya está activo, lo removemos (toggle)
    if (params.get(tipo) === valor) {
        params.delete(tipo);
    } else {
        params.set(tipo, valor);
    }
    
    // Mantener página 1 al filtrar
    params.delete('page');
    
    window.location.search = params.toString();
}

// Buscar con Enter
document.querySelector('input[name="q"]').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const url = new URL(window.location);
        const params = new URLSearchParams(url.search);
        
        if (this.value) {
            params.set('q', this.value);
        } else {
            params.delete('q');
        }
        
        params.delete('page');
        window.location.search = params.toString();
    }
});

// Aplicar filtro de precio
document.querySelectorAll('.precio-input').forEach(input => {
    input.addEventListener('change', function() {
        const url = new URL(window.location);
        const params = new URLSearchParams(url.search);
        
        const precioMin = document.querySelector('input[name="precio_min"]').value;
        const precioMax = document.querySelector('input[name="precio_max"]').value;
        
        if (precioMin) params.set('precio_min', precioMin);
        else params.delete('precio_min');
        
        if (precioMax) params.set('precio_max', precioMax);
        else params.delete('precio_max');
        
        params.delete('page');
        window.location.search = params.toString();
    });
});

function verDetalleRapido(productoId) {
    window.location.href = `/productos/${productoId}/`;
}

function agregarAlCarritoRapido(productoId) {
    fetch(`/carrito/agregar/${productoId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new FormData()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCartCount(data.carrito_count);
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al agregar al carrito', 'error');
    });
}

function agregarFavorito(productoId) {
    console.log('Agregar a favoritos:', productoId);
    showNotification('Producto agregado a favoritos', 'success');
}

function updateCartCount(count) {
    const cartCount = document.getElementById('carrito-count');
    if (cartCount) {
        cartCount.textContent = count;
    }
}

function showNotification(message, type) {
    alert(message);
}

document.querySelectorAll('.producto-card').forEach(card => {
    card.addEventListener('click', function() {
        const productoId = this.dataset.productoId;
        verDetalleRapido(productoId);
    });
});
</script>
{% endblock %}